{% load staticfiles %}
<!DOCTYPE html>
<html>
  <head>
    <script src="{% static 'js/moment.js' %}"></script>
    <script src="{% static 'js/chart.js' %}"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <link rel="stylesheet" href="{% static 'css/jquery-ui.css' %}">
  </head>
  <body>
    <h1>Smart Storm Drain</h1>
    <h3>Select a Device, Metric, and DateTime Range</h3>
    {% block content %}
    <form method="POST" class="post-form">{% csrf_token %}
        {{ form.as_p }}
        <label>DateTime: </label>
        <input type="text" name="datetimes" size="32" label="DateTime"/>
        <br>
        <br>
        <button type="submit" class="save btn btn-default">Submit</button>
    </form>
    {% endblock %}
    <canvas id="myChart"></canvas>
    <h2>
      <a href="{% url 'ui' %}">Final User Interface Vision</a>
    </h2>
  </body>
</html>

<!--DateTimepicker JavaScript-->
<script>
  $(function() {
    $('input[name="datetimes"]').daterangepicker({
      timePicker: true,
      minDate: new Date("{{ dates.min_day.isoformat }}"),
      maxDate: new Date("{{ dates.max_day.isoformat }}"),
      startDate: new Date("{{ dates.start_day.isoformat }}"),
      endDate: new Date("{{ dates.end_day.isoformat }}"),
      locale: {
        format: 'M/DD/YY hh:mm A'
      }
    });
  });
</script>

<!--Charts JavaScript-->
<script type="text/javascript">
  // Get the chart reference in the template
  var ctx = document.getElementById('myChart');

  // Use metric value to determine which chart to render
  if ('{{ metric }}' == 'depth') {
    // Line chart for water depth
    var myLineChart = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [{
            backgroundColor: 'rgba(0,102,255,0.5)',
            borderColor: 'rgba(0,102,255,0.5)',
            data: [
              {% for transmission in transmissions %}
              {
                x: new Date("{{ transmission.timestamp.isoformat }}"),
                y: {{ transmission.depth }}
              },
              {% endfor %}
            ]
          }]
        },
        options: {
          legend: {
            display: false
          },
          title: {
            display: true,
            text: 'Water Depth of {{ device.name }}',
            fontSize: 30
          },
          scales: {
            xAxes: [{
              type: 'time',
              scaleLabel: {
                display: true,
                labelString: 'Datetime',
                fontSize: 20
              }
            }],
            yAxes: [{
              scaleLabel: {
                display: true,
                labelString: 'Depth (ft)',
                fontSize: 20
              }
            }],
          }
        }
    });
  }

  // Assigns proper point colors based on the flowrate
  var pointBackgroundColors = [
    {% for transmission in transmissions %}
      {% if transmission.flowrate == 1 %}
        'rgba(0,204,0,0.5)',
      {% elif transmission.flowrate == 2 %}
        'rgba(255,204,0,0.5)',
      {% elif transmission.flowrate == 3 %}
        'rgba(255,0,0,0.5)',
      {% else %}
        'rgba(128,128,128,0.5)',
      {% endif %}
    {% endfor %}
  ];
  var pointBorderColors = [
    {% for transmission in transmissions %}
      {% if transmission.flowrate == 1 %}
        'rgba(0,204,0,1)',
      {% elif transmission.flowrate == 2 %}
        'rgba(255,204,0,1)',
      {% elif transmission.flowrate == 3 %}
        'rgba(255,0,0,1)',
      {% else %}
        'rgba(128,128,128,1)',
      {% endif %}
    {% endfor %}
  ];

  if ('{{ metric }}' == 'flowrate') {
    // Bar chart for flow rate
    var myBarChart = new Chart(ctx, {
        type: 'bar',
        data: {
          datasets: [{
            backgroundColor: pointBackgroundColors,
            borderColor: pointBorderColors,
            borderWidth: 1,
            data: [
              {% for transmission in transmissions %}
              {
                x: new Date("{{ transmission.timestamp.isoformat }}"),
                y: {{ transmission.flowrate }}
              },
              {% endfor %}
            ],
          }]
        },
        options: {
          legend: {
            display: false
          },
          title: {
            display: true,
            text: 'Flow Rate of {{ device.name }}',
            fontSize: 30
          },
          scales: {
            xAxes: [{
              type: 'time',
              scaleLabel: {
                display: true,
                labelString: 'Datetime',
                fontSize: 20
              }
            }],
            yAxes: [{
              scaleLabel: {
                display: true,
                labelString: 'Flow Rate',
                fontSize: 20
              },
              ticks: {
                beginAtZero: true,
                suggestedMax: 3,
                callback: function(label) {
                  switch(label) {
                    case 0:
                      return 'None';
                    case 1:
                      return 'Low';
                    case 2:
                      return 'Medium';
                    case 3:
                      return 'High';
                  }
                }
              }
            }],
          },
        }
    });
  }

  if ('{{ metric }}' == 'voltage') {
    // Line chart for battery voltage
    var myLineChart = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [{
            backgroundColor: 'rgba(0,204,0,0.5)',
            borderColor: 'rgba(0,204,0,0.5)',
            data: [
              {% for transmission in transmissions %}
              {
                x: new Date("{{ transmission.timestamp.isoformat }}"),
                y: {{ transmission.voltage }}
              },
              {% endfor %}
            ]
          }]
        },
        options: {
          legend: {
            display: false
          },
          title: {
            display: true,
            text: 'Battery Voltage of {{ device.name }}',
            fontSize: 30
          },
          scales: {
            xAxes: [{
              type: 'time',
              scaleLabel: {
                display: true,
                labelString: 'Datetime',
                fontSize: 20
              },
            }],
            yAxes: [{
              scaleLabel: {
                display: true,
                labelString: 'Voltage (V)',
                fontSize: 20
              },
              ticks: {
                suggestedMin: 2.9
              }
            }],
          }
        }
    });
  }
</script>
